---
date: 2026-01-22
session: schema-inference-enhancement
objective: Enhance physical planner schema inference for computed expressions and aggregations
status: completed
---

## Objective

Fix the `LocalPhysicalPlanner` schema inference to properly support:
1. Computed expressions in projections (e.g., `_id + 10`)
2. Aggregate operations (COUNT, SUM, AVG, MIN, MAX)

## Completed

1. **Schema Inference Module** (`src/grism-engine/src/planner/schema_inference.rs`)
   - Created new module for type inference from LogicalExpr + PhysicalSchema
   - `infer_expr_type()` - infers Arrow DataType for any LogicalExpr
   - `build_project_schema()` - builds schema for projections including computed expressions
   - `build_aggregate_schema()` - builds schema for aggregate operations
   - Handles all expression types: Literal, Column, Binary, Unary, Aggregate, Alias, Case, InList, Between

2. **Updated LocalPhysicalPlanner** (`src/grism-engine/src/planner/local.rs`)
   - Replaced ad-hoc project schema inference with `build_project_schema()`
   - Replaced `PhysicalSchema::empty()` in aggregate with `build_aggregate_schema()`

3. **Added Integration Tests**
   - `test_project_computed_expression` - projects `_id + 10` as computed column
   - `test_aggregate_count` - COUNT(*) on nodes
   - `test_aggregate_sum` - SUM(_id) = 15
   - `test_aggregate_avg` - AVG(_id) = 3.0
   - `test_aggregate_min_max` - MIN(_id) = 1, MAX(_id) = 5

## Files Changed

### Created
- `src/grism-engine/src/planner/schema_inference.rs` - Schema inference utilities

### Modified
- `src/grism-engine/src/planner/mod.rs` - Added schema_inference module export
- `src/grism-engine/src/planner/local.rs` - Updated to use new schema inference
- `src/grism-engine/tests/integration.rs` - Added 5 new integration tests

## Tests

- **Unit tests**: 97 passed (7 new schema inference tests)
- **Integration tests**: 17 passed (5 new tests added)
- **Total**: 114 tests passing

## Notes

- The schema inference handles type promotion for mixed Int64/Float64 arithmetic
- COUNT always returns Int64 regardless of input type
- AVG always returns Float64
- MIN/MAX preserve input type
- Unknown types default to Utf8 to avoid planning failures

## Next Steps

None - enhancement complete.
