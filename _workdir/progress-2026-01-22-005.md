---
date: 2026-01-22
session: python-api-optimization
objective: Optimize Rust-side Python API exposure following Daft pattern
status: completed
---

# Optimize Python API Exposure (Daft Pattern)

## Objective

Refactor Grism's Python bindings to follow the Daft pattern where each crate manages its own Python bindings with a `register_modules` function, while maintaining centralized orchestration in the main crate.

## Completed

- Created `src/grism-logical/src/python/mod.rs` with PyExpr, PyAggExpr, PyPattern classes and all expression functions
- Created `src/grism-engine/src/python/mod.rs` with PyExecutor, PyLocalExecutor, PyRayExecutor classes
- Added `register_modules()` function to each crate following Daft pattern
- Updated main `src/python/mod.rs` to use new registration pattern
- Updated `src/python/hypergraph.rs` to import from crate Python modules
- Removed old monolithic files (`expressions.rs`, `executor.rs`) from main crate
- Verified compilation with `cargo check --features python`
- All workspace tests pass (96+ tests in grism-logical, 2 in grism-engine)

## Files Changed

### New Files
- `src/grism-logical/src/python/mod.rs` - Expression bindings (~1200 lines)
  - `PyExpr`, `PyAggExpr`, `PyPattern` classes
  - `ExprKind` enum and conversion utilities
  - All expression functions (col, lit, aggregations, string/math/date functions)
  - `register_modules()` function
- `src/grism-engine/src/python/mod.rs` - Executor bindings (~100 lines)
  - `PyExecutor`, `PyLocalExecutor`, `PyRayExecutor` classes
  - `register_modules()` function

### Modified Files
- `src/grism-logical/src/lib.rs` - Added `#[cfg(feature = "python")] pub mod python;`
- `src/grism-engine/src/lib.rs` - Added `#[cfg(feature = "python")] pub mod python;`
- `src/python/mod.rs` - Rewritten to use Daft registration pattern
- `src/python/hypergraph.rs` - Updated imports to use crate Python modules

### Deleted Files
- `src/python/expressions.rs` - Moved to grism-logical
- `src/python/executor.rs` - Moved to grism-engine

## Tests

- grism-logical: 96 passed, 0 failed (includes 5 new Python tests)
- grism-engine: 2 passed, 0 failed
- All workspace tests: pass
- Doc-tests: 20 passed

## Notes

- Following the Daft pattern from `daft-python-rust-expose.md`:
  - Each crate has `src/python/mod.rs` with Python bindings
  - Each crate exports `register_modules(parent: &Bound<PyModule>) -> PyResult<()>`
  - Python code gated behind `#[cfg(feature = "python")]`
  - Main crate calls each sub-crate's `register_modules`
- Complex types spanning multiple crates (PyHypergraph, Frame types) remain in main crate
- Linker errors during `cargo build --features python` are expected (cdylib needs Python library); use `cargo check` for validation
- User added `explode()` method to `PyNodeFrame` after the refactoring

## Next Steps

- None - refactoring complete
