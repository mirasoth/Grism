---
date: 2026-01-22
session: impl-physical-engine
objective: Implement physical planning and local execution engine per spec
status: completed
---

## Objective

Implement the physical planning and local execution engine as specified in `specs/6_physical_planning_impl.md`. This includes the complete rewrite of `grism-engine` crate with Arrow-native operators and pull-based execution.

## Completed

1. **Core Infrastructure**
   - Updated `Cargo.toml` with required dependencies (arrow, grism-storage)
   - Created module structure: `physical/`, `operators/`, `executor/`, `memory/`, `metrics/`, `planner/`

2. **Physical Plan Model**
   - `PhysicalSchema` - Arrow schema wrapper with graph metadata
   - `PhysicalSchemaBuilder` - Builder pattern for schema construction
   - `PlanProperties` - Execution mode, partitioning, blocking info
   - `PartitioningSpec` - RFC-0010 placeholder for distributed execution
   - `PhysicalPlan` - Container for physical operator tree

3. **Physical Operator Framework**
   - `PhysicalOperator` trait - Pull-based execution with lifecycle (open → next → close)
   - `OperatorCaps` - Capabilities (blocking, stateless, pushdown support)
   - `OperatorState` - State machine for operator lifecycle

4. **Runtime Infrastructure**
   - `ExecutionContext` - Shared context with storage, memory, metrics
   - `RuntimeConfig` - Configuration (batch size, memory limit, parallelism)
   - `MemoryManager` trait with `NoopMemoryManager` and `TrackingMemoryManager`
   - `MetricsSink` and `OperatorMetrics` for statistics collection
   - `CancellationHandle` for cooperative query cancellation

5. **Physical Operators**
   - Source: `NodeScanExec`, `HyperedgeScanExec`, `EmptyExec`
   - Unary: `FilterExec`, `ProjectExec`, `LimitExec`, `RenameExec`
   - Expand: `AdjacencyExpandExec`, `RoleExpandExec`
   - Blocking: `HashAggregateExec`, `SortExec`, `CollectExec`
   - Binary: `UnionExec`

6. **Physical Planner**
   - `PhysicalPlanner` trait for extensibility
   - `LocalPhysicalPlanner` - Converts LogicalOp to physical operators
   - `PlannerConfig` - Planner configuration options

7. **Local Executor**
   - `LocalExecutor` - Pull-based pipeline executor
   - `ExecutionResult` - Holds batches, schema, metrics, elapsed time
   - Cancellation support and memory tracking

## Files Changed

### Created
- `src/grism-engine/src/physical/mod.rs` - Physical plan module exports
- `src/grism-engine/src/physical/schema.rs` - PhysicalSchema implementation
- `src/grism-engine/src/physical/properties.rs` - Plan properties and operator caps
- `src/grism-engine/src/physical/plan.rs` - PhysicalPlan struct
- `src/grism-engine/src/operators/mod.rs` - Operators module exports
- `src/grism-engine/src/operators/traits.rs` - PhysicalOperator trait
- `src/grism-engine/src/operators/empty.rs` - EmptyExec
- `src/grism-engine/src/operators/scan.rs` - NodeScanExec, HyperedgeScanExec
- `src/grism-engine/src/operators/filter.rs` - FilterExec
- `src/grism-engine/src/operators/project.rs` - ProjectExec
- `src/grism-engine/src/operators/limit.rs` - LimitExec
- `src/grism-engine/src/operators/expand.rs` - AdjacencyExpandExec, RoleExpandExec
- `src/grism-engine/src/operators/aggregate.rs` - HashAggregateExec
- `src/grism-engine/src/operators/sort.rs` - SortExec
- `src/grism-engine/src/operators/union.rs` - UnionExec
- `src/grism-engine/src/operators/rename.rs` - RenameExec
- `src/grism-engine/src/operators/collect.rs` - CollectExec
- `src/grism-engine/src/memory/mod.rs` - Memory module exports
- `src/grism-engine/src/memory/manager.rs` - MemoryManager implementations
- `src/grism-engine/src/metrics/mod.rs` - Metrics collection
- `src/grism-engine/src/executor/mod.rs` - Executor module exports
- `src/grism-engine/src/executor/context.rs` - ExecutionContext
- `src/grism-engine/src/executor/local.rs` - LocalExecutor
- `src/grism-engine/src/executor/result.rs` - ExecutionResult
- `src/grism-engine/src/planner/mod.rs` - Planner module exports
- `src/grism-engine/src/planner/local.rs` - LocalPhysicalPlanner

### Modified
- `src/grism-engine/src/lib.rs` - Complete rewrite with module structure
- `src/grism-engine/Cargo.toml` - Added arrow, grism-storage dependencies
- `src/grism-storage/src/lib.rs` - Export InMemoryStorage
- `src/common/error/src/error.rs` - Added error constructors (execution, cancelled, etc.)

### Deleted
- `src/grism-engine/src/executor.rs` - Old placeholder
- `src/grism-engine/src/node.rs` - Old placeholder
- `src/grism-engine/src/result.rs` - Old placeholder

## Tests

- 60 tests passing in grism-engine
- Full workspace builds successfully
- All operator lifecycle tests pass
- Planner conversion tests pass

## Key Design Decisions

1. **Pull-based execution** - Operators return `Option<RecordBatch>` via `next()`
2. **Operator lifecycle** - RFC-0008 compliant: create → open → next* → close
3. **Arrow-native** - All data exchange via Arrow RecordBatch
4. **Schema with qualifiers** - PhysicalSchema tracks entity qualifiers for columns
5. **Scan operators convert entity objects to Arrow** - Bridge between storage and execution
6. **Expand operators** - AdjacencyExpandExec for binary edges, RoleExpandExec for n-ary

## RFC Compliance

- RFC-0008: Physical layer design (lifecycle, data model)
- RFC-namings: `*Exec` naming for physical operators
- RFC-0010: Extension points for distributed execution (partitioning placeholders)

## Next Steps

1. Implement full expression evaluation in FilterExec, ProjectExec
2. Implement actual aggregation logic in HashAggregateExec
3. Implement sorting in SortExec
4. Add projection/predicate pushdown optimizations
5. Implement variable-length path expansion
6. Add more integration tests with real data
