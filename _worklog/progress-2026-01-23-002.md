---
date: 2026-01-23
session: polish-grism-ray-api
objective: Polish grism-ray API for consistency with RFC-namings and RFC-0102
status: completed
---

## Objective

Polish the grism-ray crate API for consistency with RFC-namings and RFC-0102, fixing naming issues, removing duplicate concepts, and updating the RFC to reflect the two-crate architecture decision.

## Completed

### 1. Updated RFC-0102 for Two-Crate Architecture
- Updated Section 1 (Abstract) to clarify two-crate structure
- Updated Section 4.1 (Overview) with new ASCII diagram showing grism-engine contains both common layer AND local runtime
- Updated Section 4.2 (Crate Responsibilities) table to remove grism-local row
- Updated Section 6 heading from "(grism-local)" to "(in grism-engine)"

### 2. Renamed Stage to ExecutionStage
- Per RFC-namings Section 10.3, canonical name is `ExecutionStage`
- Renamed struct and all references in grism-ray crate
- Updated `StageBuilder` to `ExecutionStageBuilder`

### 3. Removed ShuffleStrategy, Consolidated with ExchangeMode
- Removed redundant `ShuffleStrategy` enum from stage.rs
- Updated `ExecutionStage` to use `input_exchange` and `output_exchange` fields with `ExchangeMode`
- Single consistent enum for data movement semantics

### 4. Removed Deprecated LegacyRayPlanner
- Removed `LegacyRayPlanner` struct (lines 247-347)
- Removed `RayPlanner` type alias
- Removed `PlannerConfig` type alias (now use `DistributedPlannerConfig`)

### 5. Moved DistributedPlan to planner/ Module
- Moved `DistributedPlan` from executor.rs to planner/mod.rs
- Updated all imports and exports
- Better organization: planning output lives in planner module

### 6. Fixed ExecutionStage Operator Storage
- Changed from `operators: Vec<LogicalOp>` to `operator_names: Vec<String>`
- Stores operator metadata instead of full operator trees
- More appropriate for serialization and display

### 7. Updated lib.rs Exports
- Clean, organized exports grouped by functionality
- Updated documentation to reference new type names

### 8. Added Comprehensive Tests
- Added tests for DistributedPlan creation, topological order, root stages
- Added tests for ExecutionStage with exchange modes
- Added tests for explain output format

## Files Changed

### Modified
- `specs/rfc-0102.md` - Updated Sections 1, 4, and 6 for two-crate architecture
- `src/grism-ray/src/planner/stage.rs` - Renamed Stage to ExecutionStage, removed ShuffleStrategy
- `src/grism-ray/src/planner/mod.rs` - Added DistributedPlan, removed LegacyRayPlanner
- `src/grism-ray/src/executor.rs` - Removed DistributedPlan (moved), updated references
- `src/grism-ray/src/worker/mod.rs` - Updated to use ExecutionStage
- `src/grism-ray/src/worker/task.rs` - Updated to use ExecutionStage
- `src/grism-ray/src/lib.rs` - Updated exports

## Tests

```
make test
All tests passed (28 grism-ray tests + all other crate tests)
```

## Lint

```
make lint
clippy passes with no warnings
```

## Notes

### API Changes Summary

| Before | After |
|--------|-------|
| `Stage` | `ExecutionStage` |
| `StageBuilder` | `ExecutionStageBuilder` |
| `ShuffleStrategy` | Removed (use `ExchangeMode`) |
| `Stage.operators: Vec<LogicalOp>` | `ExecutionStage.operator_names: Vec<String>` |
| `Stage.shuffle: ShuffleStrategy` | `ExecutionStage.input_exchange/output_exchange: Option<ExchangeMode>` |
| `LegacyRayPlanner` | Removed |
| `DistributedPlan` in executor.rs | `DistributedPlan` in planner/mod.rs |

### Architecture Decision Documented
- RFC-0102 now explicitly states we use a two-crate architecture
- grism-engine contains BOTH common engine layer AND local runtime
- grism-ray contains distributed Ray runtime only
- This is a conscious deviation from the original three-crate design

## Next Steps

1. Implement actual exchange insertion logic in DistributedPlanner
2. Implement two-phase aggregation for distributed execution
3. Add Ray integration when Ray Rust bindings are available
